<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jeux vid√©o, websocket et binaire : du temps r√©el efficace dans le navigateur</title>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h3>Jeux vid√©o, websocket & binaire<br/><small>du temps r√©el efficace dans le navigateur</small></h3>
        </section>
        <section>
          <section data-background-size="contain">
            <h4>Qu'est-ce que les Websocket ?</h4>
            <!-- <img class="r-stretch" src="img/sockette.webp"> -->
          </section>
          <section>
            <h4>Vous en avez d√©j√† utilis√© !</h4>
            <img class="" src="img/miro.png" />
            <!-- Exemple miro, curvytron -->
          </section>
          <section>
            <h4>Connexion persistante et bidirectionelle</h4>
            <img class="r-stretch" src="img/websocket.svg" />
          </section>
          <section>
            <h4>Le protocol</h4>
            <!-- Connexion bidirectionnelle persistante entre un serveur web et un navigateur sur un socket TCP -->
            <img class="r-stretch" src="img/handshake.svg">
          </section>
          <section>
            <h4>Handshake ü§ù</h4>
            <img class="" src="img/handshake.png" />
          </section>
          <section>
            <h4>Communication texte (JSON)</h4>
            <!-- JSON -->
            <img src="img/json.png" />
          </section>
          <section>
            <h4>C'est cool ! √áa va vite !</h4>
            <h4 class="fragment">Mais peut-on faire mieux ?</h4>
          </section>
        </section>
        <section>
          <section>
            <h4>Que se passe-t-il quand on communique en JSON ?</h4>
            <!-- JSON est en binaire en vrai, mais pas optimis√© -->
          </section>
          <section>
            <pre><code class="hljs json" id="json1">{ "name": "client", "id": 42 }</code></pre>
            <pre class="fragment"><code class="hljs txt code-inline">[123 32 34 110 97 109 101 34 58 32 34 99 108 105 101 110 116 34 44 32 34 105 100 34 58 32 52 50 32 125]</code></pre>
            <div class="fragment">
              <pre><code class="hljs txt code-inline">01111011 00100000 00100010 01101110 01100001 01101101 01100101 00100010 00111010 00100000 00100010 01100011 01101100 01101001 01100101 01101110 01110100 00100010 00101100 00100000 00100010 01101001 01100100 00100010 00111010 00100000 00110100 00110010 00100000 01111101</code></pre>
              <p class="caption fragment">30 charact√®res / 30 octets</p>
            </div>
          </section>
          <section>
            <h4>Parlons directement binaire ! ü§ñ</h4>
          </section>
          <section data-background-image="img/matrix.jpg">
            <h5>Representation num√©rique</h5>
            <!-- Toute information doit √™tre represent√© num√©riquement -->
          </section>
          <section>
            <h5>Mon information</h5>
            <pre class=""><code class="hljs json">{ "name": "client", "id": 42 }</code></pre>
            <pre class="fragment"><code class="">[client, 42]</code></pre>
            <pre class="fragment"><code class="">[message, clientId]</code></pre>
          </section>
          <section>
            <img class="r-stretch" src="img/morse.jpeg">
          </section>
          <section>
            <table>
              <thead>
                <tr>
                  <th>Message</th>
                  <th>Id</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>client:new</td>
                  <td>1</td>
                </tr>
                <tr>
                  <td>client:left</td>
                  <td>2</td>
                </tr>
                <tr>
                  <td>client:name</td>
                  <td>3</td>
                </tr>
                <tr>
                  <td>game:new</td>
                  <td>4</td>
                </tr>
                <tr>
                  <td colspan="2">...</td>
                </tr>
              </tbody>
            </table>
          </section>
          <section>
            <pre><code>[client:new, clientId]</code></pre>
            <pre><code>[1, 42]</code></pre>
            <pre><code>00000001 00101010</code></pre>
            <p class="caption">2 octets</p>
          </section>
          <section>
            <h4>Plus complexe ...</h4>
            <pre><code class="hljs json">{
  "name": "player:position",
  "id":   42,
  "x":    3466,
  "y":    6046
}</code></pre>
          </section>
          <section>
            <pre><code>[player:position, clientId, X, Y]</code></pre>
            <pre><code>[5, 42, 3466, 6046]</code></pre>
            <div class="fragment">
              <pre><code>00000101 00101010 110110001010 1011110011110</code></pre>
              <p class="caption">6 octets</p>
            </div>
          </section>
          <!-- <section>
            <h4>Avec du texte</h4>
            <pre><code class="hljs json">{
  "name":  "player:name",
  "id":    42,
  "value": "Tom32i",
}</code></pre>
          </section> -->
          <!-- <section>
            <pre><code>[id, clientId, length, T, o, m, 3, 2, i]</code></pre>
            <pre><code>[6, 42, 6, 84, 111, 109, 51, 50, 105]</code></pre>
            <div class="fragment">
              <pre><code>00000110 00101010 00000110 01010100 01101111 01101101 00110011 00110010 01101001</code></pre>
              <p class="caption">9 octets</p>
            </div>
          </section> -->
        </section>
        <section>
          <section>
            <h4>La r√©ception</h4>
            <pre class="fragment"><code>00000111 00101010 00000001</code></pre>
          </section>
          <section>
            <h4>Decodage du premier octet</h4>
            <!-- Pour savoir √† quel message j'ai affaire -->
            <pre class="fragment"><code>00000111</code></pre>
            <pre class="fragment"><code>7</code></pre>
            <pre class="fragment"><code>player:kill</code></pre>
          </section>
          <section>
            <h4>Decodage du reste du message</h4>
            <!-- Pour savoir √† quel message j'ai affaire -->
            <pre class="fragment"><code>[player:kill, killerID, killedID]</code></pre>
            <pre class="fragment"><code>00000111 00101010 00000001</code></pre>
            <pre class="fragment"><code>7, 42, 1</code></pre>
            <pre class="fragment"><code>"Player 42 killed player 1"</code></pre>
          </section>
        </section>
        <section>
          <section>
            <h3>Codons un Miro ! üéâ</h3>
          </section>
          <section>
            <h4>Encoder/Decoder</h4>
            <img class="r-stretch" src="img/codec.svg">
          </section>
          <section>
            <pre><code class="hljs go">type Codec interface {
  encode(buffer *bytes.Buffer, data any)
  decode(buffer *bytes.Buffer) any
}</code></pre>
          </section>
          <section>
            <h4>Codec de base</h4>
            <pre><code class="hljs go">type Int8Codec struct {}

func (c *Int8Codec) encode(buffer *bytes.Buffer, message any) {
    buffer.Write([]byte{message.(uint8)})
}

func (c *Int8Codec) decode(buffer *bytes.Buffer) any {
    return buffer.Next(1)[0]
}</code></pre>
          </section>
          <section>
            <pre><code class="hljs go">type Int16Codec struct {}

func (c *Int16Codec) encode(buffer *bytes.Buffer, message any) {
    b := make([]byte, 2)
    binary.BigEndian.PutUint16(b[0:], message.(uint16))
    buffer.Write(b)
}

func (c *Int16Codec) decode(buffer *bytes.Buffer) any {
    return binary.BigEndian.Uint16(buffer.Next(2)[0:])
}</code></pre>
          </section>
          <section>
            <h4>Codec composite</h4>
            <pre><code class="hljs go">type PositionCodec struct {
  int8Codec *Int8Codec
  int16Codec *Int16Codec
}

type ClientPosition struct {
  Id uint8
  X uint16
  Y uint16
}</code></pre>
          </section>
          <section>
            <pre><code class="hljs go">func (c *PositionCodec) encode(buffer *bytes.Buffer, data any) {
    message := data.(ClientPosition)
    c.int8Codec.encode(buffer, message.Id)
    c.int16Codec.encode(buffer, message.X)
    c.int16Codec.encode(buffer, message.Y)
}

func (c *PositionCodec) decode(buffer *bytes.Buffer) any {
    return ClientPosition{
        Id: c.int8Codec.decode(buffer).(uint8),
        X: c.int16Codec.decode(buffer).(uint16),
        Y: c.int16Codec.decode(buffer).(uint16),
    }
}</code></pre>
          </section>
          <section>
            <img class="r-stretch" src="img/encoder.svg">
          </section>
          <section>
            <pre><code class="hljs go">type BinaryEncoder struct {
  idCodec Int8Codec
  codecs  map[uint8]RegisteredCodec
}

type RegisteredCodec struct {
  Id      uint8
  Name    string
  Handler Codec
}</code></pre>
          </section>
          <section>
            <pre><code class="hljs go">func (e BinaryEncoder) Encode(message Message) []byte {
  var buffer bytes.Buffer

  codec := e.codecsByName[message.Name]

  e.idCodec.encode(&buffer, codec.Id)
  codec.Handler.encode(&buffer, message.Data)

  return buffer.Bytes()
}</code></pre>
          </section>
          <section>
            <pre><code class="hljs go">func (e BinaryEncoder) Decode(data []byte) Message {
  var buffer = bytes.NewBuffer(data)

  id := e.idCodec.decode(buffer)
  codec := e.codecsById[id]

  return Message{
    Name: codec.Name,
    Data: codec.Handler.decode(buffer),
  }
}</code></pre>
          </section>
          <section>
            <h4>Listes des messages</h4>
            <pre><code class="hljs go">codec.CreateBinaryEncoder([]codec.RegisteredCodec{
  {0, "me:id", codec.Int8Codec{}},
  {1, "me:name", codec.StringCodec{}},
  {2, "me:position", codec.CreatePositionCodec()},
  {3, "client:add", codec.CreateClientAddCodec()},
  {4, "client:remove", codec.Int8Codec{}},
  {5, "client:name", codec.CreateClientNameCodec()},
  {6, "client:position", codec.CreatePositionCodec()},
})</code></pre>
          </section>
          <section>
            <h4>Gorilla Websocket</h4>
            <pre><code class="hljs go">func (s *Server) Handler(w http.ResponseWriter, r *http.Request) {
  socket, err := server.upgrader.Upgrade(w, r, nil)
  client := s.createClient(socket)
  go client.run(s)
}

http.HandleFunc("/ws", server.Handler)</code></pre>
          </section>
          <section>
            <h4>Ecriture</h4>
            <pre><code class="hljs go">func (c *Client) write(data []byte) {
  c.socket.WriteMessage(websocket.BinaryMessage, data)
}</code></pre>
          </section>
          <section>
            <h4>Reception</h4>
            <pre><code class="hljs go">func (c *Client) run(server *Server) {
  for {
     // (type int, p []byte, err error)
    _, data, err := c.socket.ReadMessage()
    if err != nil {  /* Close socket */ }

    server.in &lt;- ClientMessage{c, c.encoder.Decode(data)}
  }
}</code></pre>
          </section>
          <section>
            <h4>Cot√© navigateur, en javascript :</h4>
            <a href="https://github.com/Tom32i/netcode">
              github.com/Tom32i/netcode
            </a>
          </section>
          <section>
          <pre><code class="hljs javascript">new BinaryEncoder([
  /*0*/['me:id', new Int8Codec()],
  /*1*/['me:name', new StringCodec()],
  /*2*/['me:position', new PositionCodec()],
  /*3*/['client:add', new ClientAddCodec()],
  /*4*/['client:remove', new Int8Codec()],
  /*5*/['client:name', new ClientNameCodec()],
  /*6*/['client:position', new PositionCodec()],
])</code></pre>
          </section>
          <section>
            <h3>Demo time !</h3>
          </section>
          <section data-background-iframe="https://go.tom32i.fr?name=Tom32i" data-background-interactive=false>
            <h5 class="fragment fade-out">go.tom32i.fr</h5>
          </section>
        </section>
        <section>
          <div class="end">
            <div class="sources">
              <h3>Ressources</h3>
              <p>üêô <a target="_blank" href="https://github.com/Tom32i/go-websocket">Tom32i/go-websocket</a></p>
              <p>üêô <a target="_blank" href="https://github.com/Tom32i/netcode-binary">Tom32i/netcode-binary</a></p>
            </div>
            <h1 class="fragment thanks">Merci !üôè</h1>
          </div>
        </section>
      </div>
    </div>
  </body>
</html>
